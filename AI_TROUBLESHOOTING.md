# AI トラブルシューティングガイド

このガイドは、Discord AI Botの「ちょっと調子が悪いみたい...ごめんね！」エラーやその他のAI関連問題を解決するためのものです。

## 🤖 よくある問題と解決方法

### 1. "ちょっと調子が悪いみたい...ごめんね！" エラー

**このエラーが表示される理由:**
- Gemini API キーの設定に問題がある
- API利用制限（クォータ）に達している
- ネットワーク接続の問題
- AI モデルへのアクセス権限がない

**解決方法:**

#### ステップ 1: AI 診断テストを実行
```
/ai-test
```
このコマンドで現在のAI設定状況を確認できます。

#### ステップ 2: エラーメッセージの内容を確認
新しいバージョンでは、より具体的なエラーメッセージが表示されます：

- 🔑 **APIキーエラー**: 管理者にAPIキーの設定を確認してもらってください
- ⏰ **利用制限エラー**: 時間をおいて再度お試しください
- 🌐 **ネットワークエラー**: インターネット接続を確認してください
- 🚫 **権限エラー**: 管理者にアクセス権限を確認してもらってください

### 2. 管理者向け: AI設定の確認方法

#### Web管理パネルでの確認
1. 管理パネルにログイン
2. `http://localhost:8080/api/ais/diagnose` にアクセス（要認証）
3. AI設定の状況を確認

#### 環境変数の確認
`.env` ファイルで以下を確認：
```bash
GEMINI_API_KEY=your_actual_api_key_here  # test_gemini_key ではないこと
```

#### API キーの取得・設定
1. [Google AI Studio](https://ai.google.dev/) にアクセス
2. 新しいAPIキーを作成
3. `.env` ファイルの `GEMINI_API_KEY` を更新
4. サーバーを再起動

### 3. AI モデル設定の最適化

#### ハイブリッドモード（推奨）
- Gemini 1.5 Pro → Gemini 1.5 Flash の順で自動フォールバック
- 高品質な応答と安定性のバランス

#### Flash専用モード
- Gemini 1.5 Flash のみ使用
- 高速で安定、コスト効率が良い

#### モード変更方法
管理パネルでAI設定を編集し、`modelMode` を変更：
- `hybrid`: ハイブリッドモード（デフォルト）
- `flash_only`: Flash専用モード

### 4. カスタムエラーメッセージの設定

各AIに個別のエラーメッセージを設定可能：

1. 管理パネルでAI設定を開く
2. 「エラーメッセージ」フィールドに任意のメッセージを入力
3. 例: 「現在メンテナンス中です。しばらくお待ちください。」

### 5. 応答遅延の調整

AIが頻繁にエラーになる場合、応答遅延を設定して負荷を軽減：

1. 管理パネルでAI設定を開く
2. 「返信遅延（ms）」を設定（例: 2000 = 2秒）
3. これにより連続リクエストによる制限を回避

## 🛠️ 高度なトラブルシューティング

### ログの確認
```bash
# サーバーログでエラー詳細を確認
npm start

# 特定のAIエラーを確認
grep "AI生成エラー" server.log
```

### API制限の確認
- [Google Cloud Console](https://console.cloud.google.com/) でクォータ使用量を確認
- 必要に応じて制限を引き上げ

### ネットワーク問題の診断
```bash
# Google AI APIへの接続テスト
curl -H "Authorization: Bearer YOUR_API_KEY" \
  https://generativelanguage.googleapis.com/v1beta/models
```

### Firebase接続の確認
- Firebaseプロジェクトの設定を確認
- 会話履歴が正しく保存されているか確認

## 📞 サポート

問題が解決しない場合：

1. **サーバーログを確認** - 詳細なエラー情報が記録されています
2. **AI診断テストを実行** - `/ai-test` コマンドを使用
3. **設定を見直し** - APIキー、権限、ネットワーク設定を確認
4. **GitHub Issues** - 新しい問題の場合はリポジトリにIssueを作成

## 🔄 改善された機能

### v2.0での改善点
- ✅ より具体的なエラーメッセージ
- ✅ 自動フォールバック機能の改善
- ✅ リアルタイム診断ツール
- ✅ カスタムエラーメッセージ対応
- ✅ 詳細なログ出力

これらの改善により、「ちょっと調子が悪いみたい...ごめんね！」エラーの原因特定と解決が大幅に簡単になりました。