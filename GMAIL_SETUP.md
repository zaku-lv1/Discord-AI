# Gmail SMTP設定ガイド

このドキュメントは、Discord AI BotでGmail SMTPサーバーを使用したメール認証システムの設定方法を説明します。

## 📧 Gmail SMTP設定について

システムは以下の用途でGmail SMTPサーバーを使用します：
- **メールアドレス認証**: 新規アカウント登録時の確認メール
- **パスワード再設定**: パスワード忘れ時の再設定メール
- **セキュリティ通知**: 重要なアカウント操作の通知

## 🛠️ Gmailアカウントの設定手順

### 1. Googleアカウントの2段階認証を有効化

1. [Googleアカウント設定](https://myaccount.google.com/)にアクセス
2. 左側のメニューから「セキュリティ」を選択
3. 「Google へのログイン」セクションで「2段階認証プロセス」をクリック
4. 指示に従って2段階認証を設定（SMS、認証アプリなど）

### 2. アプリパスワードの生成

1. 2段階認証を有効化後、再度「セキュリティ」ページに戻る
2. 「Google へのログイン」セクションで「アプリ パスワード」をクリック
3. 「アプリを選択」で「メール」を選択
4. 「デバイスを選択」で「その他（カスタム名）」を選択
5. 名前を入力（例：「Discord AI Bot」）
6. 「生成」をクリック
7. **16文字のアプリパスワードが表示されるので、必ずコピーして保存**

⚠️ **重要**: このアプリパスワードは一度しか表示されません！

### 3. 環境変数の設定

`.env`ファイルに以下の設定を追加：

```bash
# Gmail SMTP設定
GMAIL_USER=your-gmail-address@gmail.com
GMAIL_APP_PASSWORD=abcd efgh ijkl mnop
```

**設定例**:
```bash
GMAIL_USER=my-bot@gmail.com
GMAIL_APP_PASSWORD=abcdefghijklmnop
```

⚠️ **注意事項**:
- `GMAIL_USER`: 実際のGmailアドレスを入力
- `GMAIL_APP_PASSWORD`: 生成した16文字のアプリパスワードを入力（スペースありでもなしでも可）
- 通常のGoogleアカウントパスワードは使用しない

## 🔧 設定の確認

### 1. サーバー起動時のログ確認

サーバーを起動すると、以下のメッセージが表示されるはずです：

```
[情報] Gmailメールサービスが初期化されました。
[情報] Gmail送信者: your-gmail-address@gmail.com
```

### 2. エラーメッセージの対処

#### 「Gmail設定が不完全です」
```
[エラー] Gmailメールサービスの初期化に失敗しました: Gmail設定が不完全です。GMAIL_USERとGMAIL_APP_PASSWORDが必要です。
```
**対処法**: `.env`ファイルに`GMAIL_USER`と`GMAIL_APP_PASSWORD`が正しく設定されているか確認

#### 「認証に失敗しました」
```
[エラー] Gmailメールサービスの初期化に失敗しました: Invalid login: 535-5.7.8 Username and Password not accepted
```
**対処法**: 
- アプリパスワードが正しく入力されているか確認
- Gmailアドレスが正しいか確認
- 2段階認証が有効になっているか確認

## 📧 メール送信のテスト

### アカウント登録テスト
1. Web管理パネルで新しいアカウントを作成
2. 入力したメールアドレスに認証メールが届くか確認
3. メール内のリンクをクリックしてアカウントが有効化されるか確認

### パスワード再設定テスト
1. ログインページで「パスワードを忘れた方」をクリック
2. メールアドレスを入力して送信
3. パスワード再設定メールが届くか確認

## 🔒 セキュリティのベストプラクティス

### アプリパスワードの管理
- **専用アカウント推奨**: Discord AI Bot専用のGmailアカウントを作成することを推奨
- **定期的な更新**: セキュリティのため、定期的にアプリパスワードを再生成
- **アクセス制限**: 不要になったアプリパスワードは削除

### 環境変数の保護
- **本番環境**: `.env`ファイルを`.gitignore`に追加（既に設定済み）
- **チーム開発**: アプリパスワードをチーム間で共有しない
- **デプロイ**: クラウドサービスの環境変数機能を使用

## 🌍 Gmail SMTP仕様

システムが使用するGmail SMTP設定：

```javascript
{
  service: 'gmail',
  host: 'smtp.gmail.com',
  port: 587,
  secure: false, // STARTTLSを使用
  auth: {
    user: process.env.GMAIL_USER,
    pass: process.env.GMAIL_APP_PASSWORD
  }
}
```

## 🚫 トラブルシューティング

### よくある問題と解決方法

1. **メールが届かない**
   - スパムフォルダを確認
   - Gmailの送信制限を確認（1日500通まで）
   - ファイアウォールの設定を確認

2. **認証エラー**
   - 2段階認証が有効か確認
   - アプリパスワードが正しいか確認
   - Gmailアドレスのタイプミスを確認

3. **接続エラー**
   - インターネット接続を確認
   - ポート587が開いているか確認
   - VPNやプロキシの影響を確認

### サポート情報

- **Googleヘルプ**: [アプリ パスワードでログイン](https://support.google.com/accounts/answer/185833)
- **Gmail SMTP**: [Gmail SMTP設定](https://support.google.com/a/answer/176600)
- **セキュリティ**: [Google アカウントのセキュリティ](https://myaccount.google.com/security)

---

この設定により、信頼性の高いGmail SMTPサーバーを使用して、安全で確実なメール配信システムが構築されます。