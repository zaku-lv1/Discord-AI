# 名前からDiscord IDへのマッピング機能

## 概要

この機能により、AIプロンプト内で名前を使用すると、自動的に対応するDiscordユーザーへのメンションに変換されます。アカウント連携を必要とせず、AI設定で名前とDiscord IDの紐付けを行うことで実現されます。

## 機能の動作

### 基本的な使い方

1. AI設定で名前とDiscord IDのマッピングを設定
2. ユーザーがチャット内で名前を使用
3. システムが自動的に名前をDiscordメンションに変換
4. AIの応答内でも名前が自動的にメンションに変換

### 例

設定例:
```javascript
nameToIdMappings = {
  "A-kun": "123456789012345678",
  "B-chan": "987654321098765432",
  "テストユーザー": "111222333444555666"
}
```

チャット例（修正後の動作）:
- **ユーザー入力**: `"A-kunはどこにいる？"`
- **AI理解用変換**: `"<@123456789012345678>はどこにいる？"` → `"@A-kunはどこにいる？"`
- **AI応答**: `"A-kunは今忙しいみたいです"`（メンション変換なし）
- **結果**: AIは名前を理解しつつ、不要な通知を作成しない

## 対応する言語・文字

### 英語
- `Hello A-kun, how are you?` → `Hello <@123456789012345678>, how are you?`
- `Where is TestUser1?` → `Where is <@123456789012345678>?`

### 日本語
- `A-kunはどこにいる？` → `<@123456789012345678>はどこにいる？`
- `テストユーザーの話をしよう` → `<@123456789012345678>の話をしよう`

### 混合言語
- `A-kun said こんにちは to B-chan` → `<@123456789012345678> said こんにちは to <@987654321098765432>`

## マッチングルール

### 正確なマッチング
システムは以下の条件でのみ名前をマッチングします：

1. **完全単語マッチ** (`\\b名前\\b`)
2. **境界文字での区切り** (英数字、アンダースコア、ハイフン以外)
3. **句読点での区切り** (空白、句読点、文頭文末)

### 誤マッチングの防止

- ❌ `SuperA-kun` → 変換されない (部分文字列)
- ❌ `TestUser123` → `TestUser1`は変換されない
- ✅ `A-kun` → 変換される (完全マッチ)
- ✅ `A-kun、` → 変換される (句読点区切り)

## 設定方法

### AI固有の設定
AIプロファイル設定で、各AIに対して固有の名前マッピングを設定できます：

```javascript
{
  "userNicknames": {
    "123456789012345678": "A-kun",
    "987654321098765432": "B-chan"
  }
}
```

### グローバル設定
`discord_id_mappings`コレクションでシステム全体のマッピングを設定できます：

```javascript
{
  "mappings": {
    "123456789012345678": "A-kun",
    "987654321098765432": "B-chan"
  }
}
```

### 優先順位
1. AI固有の設定 (最優先)
2. グローバル設定

## 技術的詳細

### 実装場所
- ファイル: `commands/toka.js`
- 関数: `replaceNamesWithMentions()`, `replaceMentionsWithNames()`

### 処理フロー
1. グローバルマッピングを取得
2. AI固有マッピングを取得・マージ
3. 名前→Discord ID の逆マッピング作成
4. ユーザーメッセージの名前をメンションに変換（AI理解のため）
5. メンションを名前に変換してAIに送信（コンテキスト理解のため）
6. ⚠️ **重要変更**: AIの応答では名前をメンションに変換しない（不要な通知を避けるため）

### 変更履歴 (2024年12月)
- **修正**: AIの応答で自動的に名前をメンションに変換する機能を削除
- **理由**: AIが理由なくメンションを使うことを避け、自然な会話を実現
- **結果**: AIは名前を理解しつつ、不要な通知を作成しない

### パフォーマンス最適化
- 長い名前から優先して処理（部分マッチ防止）
- マッチした場合は他パターンをスキップ
- 正規表現のエスケープ処理

## トラブルシューティング

### よくある問題

1. **名前が変換されない**
   - Discord IDが正しく設定されているか確認
   - Discordサーバー内にユーザーが存在するか確認
   - 名前の前後に特殊文字がないか確認

2. **部分的に変換される**
   - より長い名前が優先されるため、短い名前の設定を確認
   - 名前の重複がないか確認

3. **予期しない変換**
   - 名前のマッピング設定を確認
   - 他の名前との競合がないか確認

### デバッグ方法

コンソールログで変換エラーを確認できます：
```
名前「A-kun」のDiscord ID「123456789」への変換に失敗: [エラー詳細]
```

## セキュリティ考慮事項

- Discord IDは適切に検証されます
- 存在しないユーザーへのマッピングは無視されます
- 正規表現インジェクション攻撃を防ぐためのエスケープ処理
- ギルドメンバー外のユーザーは変換されません

## 今後の拡張予定

- より複雑な名前パターンのサポート
- 管理画面での名前マッピング設定UI
- バルクインポート機能
- 名前変更履歴の管理

## 改善された動作 (2024年12月更新)

### 修正前の問題
- AIが応答で名前を使うたびに自動的にメンションが作成
- ユーザーが意図しない通知を受信
- 自然な会話の妨げになる

### 修正後の利点
- ✅ AIは名前を自然に理解・使用
- ✅ 不要な通知が発生しない
- ✅ ユーザーが意図したメンションのみ作成
- ✅ より自然で親しみやすい会話が可能