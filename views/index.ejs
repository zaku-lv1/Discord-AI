<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>AI管理システム</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="/favicon.ico" type="image/x-icon" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />

    <!-- Firebase Config -->
    <script>
      const firebaseConfig = <%- JSON.stringify(firebaseConfig) %>;
    </script>

    <!-- Styles and Scripts -->
    <link rel="stylesheet" href="/style.css" />
    <script
      src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"
      defer
    ></script>
    <script
      src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"
      defer
    ></script>
    <script src="/app.js" defer></script>
  </head>
  <body>
    <!-- ローディング画面 -->
    <div id="loader-container" class="loader-container">
      <div class="spinner"></div>
      <p class="loader-text">システム起動中...</p>
    </div>

    <!-- メインコンテナ -->
    <div class="container" style="display: none;">
      <h1>🤖 AI管理システム</h1>

      <!-- 認証コンテナ -->
      <div id="auth-container" style="display: none;">
        <!-- ログインフォーム -->
        <form id="login-form">
          <h2>ログイン</h2>
          <input
            type="email"
            id="login-email"
            placeholder="メールアドレス"
            required
          />
          <input
            type="password"
            id="login-password"
            placeholder="パスワード"
            required
          />
          <div class="login-actions">
            <button type="button" id="login-btn">ログイン</button>
            <a href="#" id="forgot-password-link">パスワードを忘れた場合</a>
          </div>
          <div class="switch-form-link">
            <a href="#" id="show-register-form-link"
              >招待コードをお持ちですか？ 新規登録はこちら</a
            >
          </div>
        </form>

        <!-- 登録フォーム -->
        <form id="register-form" style="display:none;">
          <h2>招待コードで新規登録</h2>
          <input
            type="text"
            id="register-invite-code"
            placeholder="招待コード"
            required
          />
          <input
            type="text"
            id="register-display-name"
            placeholder="表示名"
            required
          />
          <input
            type="email"
            id="register-email"
            placeholder="メールアドレス"
            required
          />
          <input
            type="password"
            id="register-password"
            placeholder="パスワード (6文字以上)"
            required
          />
          <div class="login-actions">
            <button type="button" id="register-btn">登録</button>
          </div>
          <div class="switch-form-link">
            <a href="#" id="show-login-form-link"
              >アカウントをお持ちですか？ ログインはこちら</a
            >
          </div>
        </form>
      </div>

      <!-- メインコンテンツ -->
      <div id="main-content" style="display: none;">
        <!-- ユーザー情報 -->
        <div class="user-info">
          <p>ようこそ, <span id="user-email"></span> さん</p>
          <button id="logout-btn">ログアウト</button>
        </div>

        <!-- ダッシュボード -->
        <div id="dashboard-container">
          <!-- ナビゲーション -->
          <nav id="dashboard-nav">
            <ul>
              <li>
                <a href="#" class="nav-link active" data-target="panel-ai-list"
                  >🤖 AI一覧</a
                >
              </li>
              <li>
                <a href="#" class="nav-link" data-target="panel-create-ai"
                  >➕ AI作成</a
                >
              </li>
              <li>
                <a href="#" class="nav-link" data-target="panel-profile"
                  >👤 プロファイル</a
                >
              </li>
              <li id="nav-item-admin" style="display: none;">
                <a href="#" class="nav-link" data-target="panel-admins"
                  >👑 管理者設定</a
                >
              </li>
            </ul>
          </nav>

          <!-- メインコンテンツエリア -->
          <main id="dashboard-content">
            <!-- AI一覧パネル -->
            <div id="panel-ai-list" class="dashboard-panel active">
              <h2>AI一覧</h2>
              <div id="ai-list-container">
                <!-- AIカードがここに動的に追加されます -->
              </div>
            </div>

            <!-- AI作成パネル -->
            <div id="panel-create-ai" class="dashboard-panel">
              <h2>新しいAIを作成</h2>
              <form id="create-ai-form">
                <div class="form-group">
                  <label for="ai-id">AI ID</label>
                  <input
                    type="text"
                    id="ai-id"
                    placeholder="例: my-assistant"
                    required
                  />
                  <small>英数字、ハイフン、アンダースコアのみ使用可能です。</small>
                </div>
                
                <div class="form-group">
                  <label for="ai-name">AI名</label>
                  <input
                    type="text"
                    id="ai-name"
                    placeholder="例: アシスタント太郎"
                    required
                  />
                  <small>Discordで表示される名前です。</small>
                </div>

                <div class="form-group">
                  <label for="ai-model-mode">AIモデルモード</label>
                  <select id="ai-model-mode">
                    <option value="hybrid">ハイブリッド (高品質)</option>
                    <option value="flash_only">Flash (高速)</option>
                  </select>
                  <small>使用するAIモデルを選択します。</small>
                </div>

                <div class="form-group">
                  <label for="ai-base-user-id">ベースユーザーID</label>
                  <input
                    type="text"
                    id="ai-base-user-id"
                    placeholder="AIの見た目と名前の元になるDiscordユーザーID"
                  />
                  <small>空白の場合はボットのデフォルト設定を使用します。</small>
                </div>

                <div class="form-group">
                  <div class="toggle-container">
                    <label for="ai-name-recognition" class="toggle-label">
                      個別の名前認識を有効にする
                    </label>
                    <label class="toggle-switch">
                      <input type="checkbox" id="ai-name-recognition" checked />
                      <span class="slider"></span>
                    </label>
                  </div>
                </div>

                <div class="form-group">
                  <div class="toggle-container">
                    <label for="ai-bot-response" class="toggle-label">
                      Botユーザーのメッセージにも反応する
                    </label>
                    <label class="toggle-switch">
                      <input type="checkbox" id="ai-bot-response" />
                      <span class="slider"></span>
                    </label>
                  </div>
                  <small>ONにするとBotユーザーの発言にもAIが反応します。</small>
                </div>

                <div class="form-group">
                  <label for="ai-reply-delay">返信ディレイ（ms単位）</label>
                  <input
                    type="number"
                    id="ai-reply-delay"
                    min="0"
                    max="10000"
                    step="100"
                    value="0"
                    placeholder="0 (即時返信)"
                  />
                  <small>1000=1秒。AIが返事するまでの遅延。0で即時。</small>
                </div>

                <div class="form-group">
                  <label for="ai-error-message">AIエラー時のメッセージ</label>
                  <input
                    type="text"
                    id="ai-error-message"
                    maxlength="200"
                    placeholder="例: ちょっと調子が悪いみたい...ごめんね！"
                  />
                  <small>Geminiが使えないときの返答。空白ならデフォルト文。</small>
                </div>

                <div class="form-group">
                  <label for="ai-system-prompt">システムプロンプト (キャラクター設定)</label>
                  <textarea
                    id="ai-system-prompt"
                    rows="8"
                    placeholder="ここにAIのキャラクター設定を入力..."
                  ></textarea>
                  <small>AIの性格や口調、役割などを詳しく設定してください。</small>
                </div>

                <div class="button-group">
                  <button type="submit" class="save-btn">AIを作成</button>
                </div>
              </form>
            </div>

            <!-- プロファイル設定パネル -->
            <div id="panel-profile" class="dashboard-panel">
              <h2>プロファイル設定</h2>

              <div class="form-group">
                <label for="profile-display-name">ユーザー名</label>
                <input
                  type="text"
                  id="profile-display-name"
                  placeholder="あなたのユーザー名"
                />
                <small>管理者から設定されたユーザー名を変更できます。</small>
              </div>

              <div class="form-group">
                <label for="profile-email">メールアドレス</label>
                <input
                  type="email"
                  id="profile-email"
                  placeholder="新しいメールアドレス"
                />
                <small>メールアドレスを変更する場合、確認メールが送信されます。</small>
              </div>

              <div class="button-group">
                <button id="save-profile-btn" class="save-btn">
                  プロファイルを保存
                </button>
              </div>
            </div>

            <!-- 管理者設定パネル -->
            <div id="panel-admins" class="dashboard-panel">
              <div id="invite-code-generator-section">
                <div class="form-group">
                  <label>新しい管理者を招待</label>
                  <button
                    type="button"
                    id="generate-invite-code-btn"
                    class="secondary-btn"
                  >
                    招待コードを生成
                  </button>
                  <div id="invite-code-display" style="display:none;">
                    <p>このコードを新しい管理者に伝えてください。</p>
                    <input type="text" id="new-invite-code" readonly />
                    <button type="button" id="copy-invite-code-btn" class="secondary-btn">
                      コピー
                    </button>
                  </div>
                </div>
              </div>
              
              <h3>管理者アカウント</h3>
              <div class="form-group">
                <label>管理者リスト</label>
                <div id="admins-list-container"></div>
                <button type="button" id="add-admin-btn" class="secondary-btn">
                  ➕ 管理者を追加
                </button>
                <small>リストの一番上の管理者が「最高管理者」です。</small>
              </div>
              <div class="button-group">
                <button id="save-admins-btn" class="save-btn">
                  管理者リストを保存
                </button>
              </div>
            </div>
          </main>
        </div>
      </div>

      <!-- ステータスメッセージ -->
      <div id="status-message"></div>
    </div>

    <!-- AI編集モーダル -->
    <div id="edit-ai-modal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2>AIを編集</h2>
        <form id="edit-ai-form">
          <input type="hidden" id="edit-ai-id" />
          
          <div class="form-group">
            <label for="edit-ai-name">AI名</label>
            <input type="text" id="edit-ai-name" required />
          </div>

          <div class="form-group">
            <label for="edit-ai-model-mode">AIモデルモード</label>
            <select id="edit-ai-model-mode">
              <option value="hybrid">ハイブリッド (高品質)</option>
              <option value="flash_only">Flash (高速)</option>
            </select>
          </div>

          <div class="form-group">
            <label for="edit-ai-base-user-id">ベースユーザーID</label>
            <input type="text" id="edit-ai-base-user-id" />
          </div>

          <div class="form-group">
            <div class="toggle-container">
              <label for="edit-ai-name-recognition" class="toggle-label">
                個別の名前認識を有効にする
              </label>
              <label class="toggle-switch">
                <input type="checkbox" id="edit-ai-name-recognition" />
                <span class="slider"></span>
              </label>
            </div>
          </div>

          <div class="form-group">
            <div class="toggle-container">
              <label for="edit-ai-bot-response" class="toggle-label">
                Botユーザーのメッセージにも反応する
              </label>
              <label class="toggle-switch">
                <input type="checkbox" id="edit-ai-bot-response" />
                <span class="slider"></span>
              </label>
            </div>
          </div>

          <div class="form-group">
            <label for="edit-ai-reply-delay">返信ディレイ（ms単位）</label>
            <input type="number" id="edit-ai-reply-delay" min="0" max="10000" step="100" />
          </div>

          <div class="form-group">
            <label for="edit-ai-error-message">AIエラー時のメッセージ</label>
            <input type="text" id="edit-ai-error-message" maxlength="200" />
          </div>

          <div class="form-group">
            <label for="edit-ai-system-prompt">システムプロンプト</label>
            <textarea id="edit-ai-system-prompt" rows="8"></textarea>
          </div>

          <div class="button-group">
            <button type="button" class="secondary-btn" id="cancel-edit-btn">キャンセル</button>
            <button type="submit" class="save-btn">変更を保存</button>
          </div>
        </form>
      </div>
    </div>
  </body>
</html>