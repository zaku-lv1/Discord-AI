<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AIè¨­å®šãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }
    
    .header h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }
    
    .header p {
      opacity: 0.9;
      font-size: 14px;
    }
    
    .content {
      padding: 30px;
    }
    
    .form-group {
      margin-bottom: 25px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
      font-size: 14px;
    }
    
    .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      resize: vertical;
      transition: border-color 0.3s;
    }
    
    .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .form-group input[type="text"],
    .form-group input[type="number"],
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
    }
    
    .form-group input[type="text"]:focus,
    .form-group input[type="number"]:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .form-hint {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }
    
    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 30px;
    }
    
    button {
      flex: 1;
      padding: 14px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .btn-save {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .btn-save:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
    }
    
    .btn-save:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .btn-reload {
      background: #f0f0f0;
      color: #333;
    }
    
    .btn-reload:hover {
      background: #e0e0e0;
    }
    
    .message {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      display: none;
    }
    
    .message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .message.show {
      display: block;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Nickname management styles */
    .nickname-add-section {
      margin-bottom: 15px;
    }
    
    .btn-add-nickname {
      padding: 12px 20px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      white-space: nowrap;
    }
    
    .btn-add-nickname:hover {
      background: #218838;
      transform: translateY(-1px);
    }
    
    .nicknames-list {
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .nickname-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 6px;
      margin-bottom: 8px;
      transition: background 0.2s;
    }
    
    .nickname-item:hover {
      background: #e9ecef;
    }
    
    .nickname-item:last-child {
      margin-bottom: 0;
    }
    
    .nickname-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .nickname-discord-id {
      font-size: 12px;
      color: #666;
      font-family: 'Courier New', monospace;
    }
    
    .nickname-name {
      font-size: 14px;
      font-weight: 600;
      color: #333;
    }
    
    .nickname-actions {
      display: flex;
      gap: 8px;
    }
    
    .btn-edit-nickname,
    .btn-delete-nickname {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-edit-nickname {
      background: #007bff;
      color: white;
    }
    
    .btn-edit-nickname:hover {
      background: #0056b3;
    }
    
    .btn-delete-nickname {
      background: #dc3545;
      color: white;
    }
    
    .btn-delete-nickname:hover {
      background: #c82333;
    }
    
    .empty-nicknames {
      text-align: center;
      padding: 30px;
      color: #999;
      font-size: 14px;
    }
    
    .nickname-input-row {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .nickname-input-row input {
      flex: 1;
    }
    
    .nickname-hint {
      margin-bottom: 15px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ¤– AIè¨­å®šãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
      <p>Discord AIãƒœãƒƒãƒˆã®è¨­å®šã‚’ç®¡ç†ã—ã¾ã™</p>
    </div>
    
    <div class="content">
      <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>è¨­å®šã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
      </div>
      
      <div id="message" class="message"></div>
      
      <form id="settings-form" style="display: none;">
        <div class="form-group">
          <label for="botName">ãƒœãƒƒãƒˆå</label>
          <input 
            type="text" 
            id="botName" 
            name="botName" 
            placeholder="AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ"
            required
          />
          <div class="form-hint">Discordã§è¡¨ç¤ºã•ã‚Œã‚‹ãƒœãƒƒãƒˆã®åå‰</div>
        </div>
        
        <div class="form-group">
          <label for="botIconUrl">ãƒœãƒƒãƒˆã‚¢ã‚¤ã‚³ãƒ³URL</label>
          <input 
            type="text" 
            id="botIconUrl" 
            name="botIconUrl" 
            placeholder="https://example.com/bot-icon.png (ä»»æ„)"
          />
          <div class="form-hint">ãƒœãƒƒãƒˆã®ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒURLï¼ˆç©ºæ¬„ã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ã‚¤ã‚³ãƒ³ï¼‰</div>
        </div>
        
        <div class="form-group">
          <label for="systemPrompt">ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</label>
          <textarea 
            id="systemPrompt" 
            name="systemPrompt" 
            rows="10" 
            placeholder="AIã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."
            required
          ></textarea>
          <div class="form-hint">AIã®æŒ¯ã‚‹èˆã„ã¨å¿œç­”æ–¹æ³•ã‚’å®šç¾©ã—ã¾ã™</div>
        </div>
        
        <div class="form-group">
          <label for="modelMode">ãƒ¢ãƒ‡ãƒ«ãƒ¢ãƒ¼ãƒ‰</label>
          <select id="modelMode" name="modelMode">
            <option value="hybrid">ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ï¼ˆProã¨Flashã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰</option>
            <option value="flash_only">Flashã®ã¿</option>
          </select>
          <div class="form-hint">ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ãƒ¢ãƒ¼ãƒ‰ã¾ãŸã¯Flashã®ã¿ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠ</div>
        </div>
        
        <div class="form-group">
          <label for="replyDelayMs">è¿”ä¿¡é…å»¶ï¼ˆãƒŸãƒªç§’ï¼‰</label>
          <input 
            type="number" 
            id="replyDelayMs" 
            name="replyDelayMs" 
            min="0" 
            step="100"
            placeholder="0"
          />
          <div class="form-hint">AIãŒå¿œç­”ã™ã‚‹ã¾ã§ã®é…å»¶æ™‚é–“ï¼ˆãƒŸãƒªç§’å˜ä½ï¼‰</div>
        </div>
        
        <div class="form-group">
          <label for="errorOopsMessage">ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</label>
          <input 
            type="text" 
            id="errorOopsMessage" 
            name="errorOopsMessage" 
            placeholder="ã¡ã‚‡ã£ã¨èª¿å­ãŒæ‚ªã„ã¿ãŸã„...ã”ã‚ã‚“ã­ï¼"
          />
          <div class="form-hint">AIã®å¿œç­”ã«å¤±æ•—ã—ãŸéš›ã®ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div>
        </div>
        
        <div class="form-group">
          <label>ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ç®¡ç†</label>
          <div class="form-hint nickname-hint">
            Discord IDã¨ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã®ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’ç®¡ç†ã—ã¾ã™ã€‚AIã¯ã“ã®ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’ä½¿ç”¨ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’èªè­˜ã—ã¾ã™ã€‚
          </div>
          
          <div class="nickname-add-section">
            <div class="nickname-input-row">
              <input 
                type="text" 
                id="newDiscordId" 
                placeholder="Discord ID (ä¾‹: 123456789012345678)"
              />
              <input 
                type="text" 
                id="newNickname" 
                placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ  (ä¾‹: å¤ªéƒ)"
              />
              <button type="button" class="btn-add-nickname" id="addNicknameBtn">â• è¿½åŠ </button>
            </div>
          </div>
          
          <div id="nicknamesList" class="nicknames-list">
            <!-- Nicknames will be populated here -->
          </div>
        </div>
        
        <div class="button-group">
          <button type="button" class="btn-reload" id="reloadBtn">â†» å†èª­ã¿è¾¼ã¿</button>
          <button type="submit" class="btn-save">ğŸ’¾ è¨­å®šã‚’ä¿å­˜</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Constants
    const DISCORD_ID_REGEX = /^\d{17,19}$/;
    
    let saveButton;
    let currentNicknames = {}; // Store current nicknames in memory
    
    document.addEventListener('DOMContentLoaded', () => {
      saveButton = document.querySelector('.btn-save');
      loadSettings();
      
      document.getElementById('settings-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        await saveSettings();
      });
      
      // Add event listener for add nickname button
      document.getElementById('addNicknameBtn').addEventListener('click', addNickname);
      
      // Add event listener for reload button
      document.getElementById('reloadBtn').addEventListener('click', loadSettings);
    });
    
    function showMessage(text, type) {
      const messageDiv = document.getElementById('message');
      messageDiv.textContent = text;
      messageDiv.className = `message ${type} show`;
      
      setTimeout(() => {
        messageDiv.classList.remove('show');
      }, 5000);
    }
    
    async function loadSettings() {
      const loading = document.getElementById('loading');
      const form = document.getElementById('settings-form');
      
      loading.style.display = 'block';
      form.style.display = 'none';
      
      try {
        const response = await fetch('/api/settings/ai');
        
        if (!response.ok) {
          throw new Error(`Failed to load settings: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        document.getElementById('botName').value = data.botName || 'AI Assistant';
        document.getElementById('botIconUrl').value = data.botIconUrl || '';
        document.getElementById('systemPrompt').value = data.systemPrompt || '';
        document.getElementById('modelMode').value = data.modelMode || 'hybrid';
        document.getElementById('replyDelayMs').value = data.replyDelayMs || 0;
        document.getElementById('errorOopsMessage').value = data.errorOopsMessage || '';
        
        // Load nicknames
        currentNicknames = data.userNicknames || {};
        renderNicknames();
        
        loading.style.display = 'none';
        form.style.display = 'block';
      } catch (error) {
        loading.style.display = 'none';
        showMessage(`è¨­å®šã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
      }
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function renderNicknames() {
      const nicknamesListDiv = document.getElementById('nicknamesList');
      
      if (Object.keys(currentNicknames).length === 0) {
        nicknamesListDiv.innerHTML = '<div class="empty-nicknames">ã¾ã ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
        return;
      }
      
      let html = '';
      for (const [discordId, nickname] of Object.entries(currentNicknames)) {
        html += `
          <div class="nickname-item">
            <div class="nickname-info">
              <div class="nickname-discord-id">Discord ID: ${escapeHtml(discordId)}</div>
              <div class="nickname-name">${escapeHtml(nickname)}</div>
            </div>
            <div class="nickname-actions">
              <button type="button" class="btn-edit-nickname" data-discord-id="${escapeHtml(discordId)}">âœï¸ ç·¨é›†</button>
              <button type="button" class="btn-delete-nickname" data-discord-id="${escapeHtml(discordId)}">ğŸ—‘ï¸ å‰Šé™¤</button>
            </div>
          </div>
        `;
      }
      
      nicknamesListDiv.innerHTML = html;
      
      // Add event listeners using event delegation
      nicknamesListDiv.querySelectorAll('.btn-edit-nickname').forEach(btn => {
        btn.addEventListener('click', () => editNickname(btn.dataset.discordId));
      });
      nicknamesListDiv.querySelectorAll('.btn-delete-nickname').forEach(btn => {
        btn.addEventListener('click', () => deleteNickname(btn.dataset.discordId));
      });
    }
    
    function addNickname() {
      const discordIdInput = document.getElementById('newDiscordId');
      const nicknameInput = document.getElementById('newNickname');
      
      const discordId = discordIdInput.value.trim();
      const nickname = nicknameInput.value.trim();
      
      if (!discordId || !nickname) {
        showMessage('Discord IDã¨ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã®ä¸¡æ–¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }
      
      // Validate Discord ID format (17-19 digits)
      if (!DISCORD_ID_REGEX.test(discordId)) {
        showMessage('Discord IDã¯17-19æ¡ã®æ•°å­—ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™', 'error');
        return;
      }
      
      // Check if Discord ID already exists
      if (currentNicknames[discordId]) {
        showMessage('ã“ã®Discord IDã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™', 'error');
        return;
      }
      
      // Add to current nicknames
      currentNicknames[discordId] = nickname;
      
      // Clear inputs
      discordIdInput.value = '';
      nicknameInput.value = '';
      
      // Re-render
      renderNicknames();
      
      showMessage('ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼ˆä¿å­˜ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ï¼‰', 'success');
    }
    
    function editNickname(discordId) {
      const currentNickname = currentNicknames[discordId];
      const newNickname = prompt('æ–°ã—ã„ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', currentNickname);
      
      if (newNickname === null) {
        // User cancelled
        return;
      }
      
      if (!newNickname.trim()) {
        showMessage('ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }
      
      // Update nickname
      currentNicknames[discordId] = newNickname.trim();
      
      // Re-render
      renderNicknames();
      
      showMessage('ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼ˆä¿å­˜ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ï¼‰', 'success');
    }
    
    function deleteNickname(discordId) {
      if (!confirm('ã“ã®ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
        return;
      }
      
      // Delete from current nicknames
      delete currentNicknames[discordId];
      
      // Re-render
      renderNicknames();
      
      showMessage('ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å‰Šé™¤ã—ã¾ã—ãŸï¼ˆä¿å­˜ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ï¼‰', 'success');
    }
    
    async function saveSettings() {
      if (saveButton.disabled) return;
      
      saveButton.disabled = true;
      saveButton.textContent = 'ğŸ’¾ ä¿å­˜ä¸­...';
      
      const formData = {
        botName: document.getElementById('botName').value,
        botIconUrl: document.getElementById('botIconUrl').value,
        systemPrompt: document.getElementById('systemPrompt').value,
        modelMode: document.getElementById('modelMode').value,
        replyDelayMs: parseInt(document.getElementById('replyDelayMs').value) || 0,
        errorOopsMessage: document.getElementById('errorOopsMessage').value,
        userNicknames: currentNicknames
      };
      
      try {
        const response = await fetch('/api/settings/ai', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
        });
        
        if (!response.ok) {
          throw new Error(`Failed to save settings: ${response.statusText}`);
        }
        
        const data = await response.json();
        showMessage(data.message || 'è¨­å®šã‚’æ­£å¸¸ã«ä¿å­˜ã—ã¾ã—ãŸï¼', 'success');
      } catch (error) {
        showMessage(`è¨­å®šã®ä¿å­˜ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
      } finally {
        saveButton.disabled = false;
        saveButton.textContent = 'ğŸ’¾ è¨­å®šã‚’ä¿å­˜';
      }
    }
  </script>
</body>
</html>
